<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Конвертація Excel → JSON</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h2>Конвертер Excel (books.xlsx) → JSON (books.json)</h2>
  <input type="file" id="excelFile" accept=".xlsx" />
  <button onclick="convert()">Конвертувати</button>
  <a id="downloadLink" style="display:none;" download="books.json">⬇️ Завантажити books.json</a>

  <script>
    function convert() {
      const fileInput = document.getElementById('excelFile');
      const file = fileInput.files[0];
      if (!file) {
        alert("Оберіть файл Excel (.xlsx)");
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const raw = XLSX.utils.sheet_to_json(sheet);

        // Обробка полів
        const books = raw.map(row => {
          const authors = row.authors || row.author || "";
          const addedRaw = row.added;

          // Конвертація дати з числа в YYYY-MM-DD
          let added = "";
          if (typeof addedRaw === 'number') {
            const date = XLSX.SSF.parse_date_code(addedRaw);
            if (date) {
              const pad = n => String(n).padStart(2, '0');
              added = `${date.y}-${pad(date.m)}-${pad(date.d)}`;
            }
          } else if (typeof addedRaw === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(addedRaw)) {
            added = addedRaw;
          }

          return {
            title: row.title || "",
            authors: (typeof authors === 'string') ? authors.split(',').map(a => a.trim()) : [],
            publisher: row.publisher || "",
            year: row.year || "",
            genre: row.genre || "",
            language: row.language || "",
            description: row.description || "",
            added: added,
            image: row.image || ""
          };
        });

        const json = JSON.stringify(books, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const link = document.getElementById('downloadLink');
        link.href = url;
        link.style.display = 'inline-block';
        link.textContent = '⬇️ Завантажити books.json';
      };

      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
