<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Бібліотечний каталог</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; padding: 1rem; }
    h1 { color: #2c3e50; }
    .search-bar, .year-filter, .genre-filter, .language-filter { margin-bottom: 1rem; }
    .alphabet { margin: 1rem 0; }
    .alphabet-row { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 0.5rem; }
    .alphabet span { cursor: pointer; margin: 0 4px; font-weight: bold; }
    .alphabet span.active { color: white; background-color: #2980b9; padding: 2px 6px; border-radius: 4px; }
    .book-list, .author-list, .pagination { margin-top: 1rem; }
    .book { background: #fff; padding: 1rem; margin-bottom: 0.5rem; border-radius: 5px; display: flex; gap: 1rem; flex-wrap: wrap; }
    .book img { width: 80px; height: auto; object-fit: cover; }
    .pagination button { margin: 2px; padding: 4px 8px; cursor: pointer; }
    .pagination button.active { background-color: #2980b9; color: white; border: none; }
    .annotation { background: #eef; padding: 8px; margin-top: 5px; border-left: 4px solid #2980b9; border-radius: 4px; display: none; }
    .badge-new { background-color: #2ecc71; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 6px; display: inline-block; }
    .badge-genre { background-color: #3498db; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 6px; display: inline-block; }
    @media (max-width: 600px) {
      .book { flex-direction: column; align-items: center; text-align: center; }
      .book img { width: 120px; }
    }
  </style>
</head>
<body>
  <h1>Бібліотечний каталог</h1>

  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Пошук книг (автор, назва, видавництво)..." style="width: 100%; padding: 8px;">
  </div>

  <div class="year-filter">
    <label for="yearSelect">Фільтр за роком:</label>
    <select id="yearSelect" onchange="applyFilters()">
      <option value="">Усі роки</option>
    </select>
  </div>

  <div class="genre-filter">
    <label for="genreSelect">Жанр:</label>
    <select id="genreSelect" onchange="applyFilters()">
      <option value="">Усі жанри</option>
    </select>
  </div>

  <div class="language-filter">
    <label for="languageSelect">Мова:</label>
    <select id="languageSelect" onchange="applyFilters()">
      <option value="">Усі мови</option>
    </select>
  </div>

  <div class="alphabet" id="alphabet">
    <div class="alphabet-row" id="ukrRow"></div>
    <div class="alphabet-row" id="engRow"></div>
  </div>

  <div class="author-list" id="authorList"></div>
  <div class="book-list" id="bookList"></div>
  <div class="pagination" id="pagination"></div>

  <script>
    let books = [];
    let currentPage = 1;
    const booksPerPage = 10;
    let filteredBooks = [];
    let activeLetter = '';

    async function loadBooks() {
      const res = await fetch('books.json');
      books = await res.json();

      books.sort((a, b) => {
        const dateA = new Date(a.added || '2000-01-01');
        const dateB = new Date(b.added || '2000-01-01');
        return dateB - dateA;
      });

      populateFilters();
      buildAlphabet();

      setTimeout(() => {
        readURLParams();
        if (!activeLetter) applyFilters();
      }, 0);
    }

    function populateFilters() {
      const years = [...new Set(books.map(b => b.year))].sort((a,b)=>b-a);
      const genres = [...new Set(books.map(b => b.genre).filter(Boolean))].sort();
      const languages = [...new Set(books.map(b => b.language).filter(Boolean))].sort();

      const yearSelect = document.getElementById('yearSelect');
      years.forEach(y => yearSelect.innerHTML += `<option value="${y}">${y}</option>`);

      const genreSelect = document.getElementById('genreSelect');
      genres.forEach(g => genreSelect.innerHTML += `<option value="${g}">${g}</option>`);

      const languageSelect = document.getElementById('languageSelect');
      languages.forEach(l => languageSelect.innerHTML += `<option value="${l}">${l}</option>`);
    }

    function buildAlphabet() {
      const ukr = "АБВГҐДЕЄЖЗИІЇЙКЛМНОПРСТУФХЦЧШЩЬЮЯ";
      const eng = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      const ukrRow = document.getElementById('ukrRow');
      const engRow = document.getElementById('engRow');
      [...ukr].forEach(letter => {
        const span = document.createElement('span');
        span.textContent = letter;
        span.onclick = () => filterByLetter(letter, span);
        ukrRow.appendChild(span);
      });
      [...eng].forEach(letter => {
        const span = document.createElement('span');
        span.textContent = letter;
        span.onclick = () => filterByLetter(letter, span);
        engRow.appendChild(span);
      });
    }

    function filterByLetter(letter, span) {
      activeLetter = letter;
      document.querySelectorAll('.alphabet span').forEach(s => s.classList.remove('active'));
      span.classList.add('active');
      const allAuthors = books.flatMap(b => Array.isArray(b.authors) ? b.authors : [b.author]);
      const authors = [...new Set(allAuthors.filter(a => a.toUpperCase().startsWith(letter)))].sort((a, b) =>  a.localeCompare(b, 'uk', { sensitivity: 'base' }));
      document.getElementById('bookList').innerHTML = '';
      document.getElementById('pagination').innerHTML = '';
      document.getElementById('authorList').innerHTML = '<h3>Автори на літеру "' + letter + '":</h3>' +
        authors.map(a => `<div onclick="showBooksByAuthor('${a}')" style="cursor:pointer; color:#2980b9">${a}</div>`).join('');
      updateURLParams();
    }

    function showBooksByAuthor(author) {
      filteredBooks = books.filter(b => (Array.isArray(b.authors) ? b.authors.includes(author) : b.author === author));
      currentPage = 1;
      renderBooks();
    }

    function applyFilters() {
      const term = document.getElementById('searchInput').value.toLowerCase();
      const year = document.getElementById('yearSelect').value;
      const genre = document.getElementById('genreSelect').value;
      const language = document.getElementById('languageSelect').value;

      filteredBooks = books.filter(b => {
        const authorText = Array.isArray(b.authors) ? b.authors.join(', ').toLowerCase() : b.author.toLowerCase();
        return (
          (b.title.toLowerCase().includes(term) ||
          authorText.includes(term) ||
          b.publisher.toLowerCase().includes(term)) &&
          (!year || b.year == year) &&
          (!genre || b.genre === genre) &&
          (!language || b.language === language)
        );
      });
      currentPage = 1;
      renderBooks();
      updateURLParams();
    }

    function renderBooks() {
      document.getElementById('authorList').innerHTML = '';
      const bookList = document.getElementById('bookList');
      const pagination = document.getElementById('pagination');

      const start = (currentPage - 1) * booksPerPage;
      const end = start + booksPerPage;
      const paginatedBooks = filteredBooks.slice(start, end);

      bookList.innerHTML = paginatedBooks.map(b => {
        const authorDisplay = Array.isArray(b.authors) ? b.authors.join(', ') : b.author;
        const annotationId = 'desc_' + Math.random().toString(36).substr(2, 9);
        const annotationLink = b.description ? `<a href="#" onclick="toggleAnnotation('${annotationId}'); return false;">Аннотація</a><br>` : '';
        const annotationBlock = b.description ? `<div id="${annotationId}" class="annotation">${b.description}</div>` : '';
        const isNew = b.added && (new Date() - new Date(b.added)) < 1000 * 60 * 60 * 24 * 30;
        const newBadge = isNew ? '<span class="badge-new">Нове надходження</span>' : '';
        const genreBadge = b.genre ? `<span class="badge-genre">${b.genre}</span>` : '';

        return `
        <div class="book">
          <img src="${b.image || 'https://via.placeholder.com/80x120?text=Книга'}" alt="${b.title}">
          <div>
            <strong>${b.title}</strong> ${newBadge}<br>
            Автор(и): ${authorDisplay}<br>
            Видавництво: ${b.publisher}, ${b.year}<br>
            ${genreBadge}<br>
            ${b.language ? 'Мова: ' + b.language + '<br>' : ''}
            ${annotationLink}
            ${annotationBlock}
          </div>
        </div>
        `;
      }).join('');

      const totalPages = Math.ceil(filteredBooks.length / booksPerPage);
      pagination.innerHTML = '';
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = i === currentPage ? 'active' : '';
        btn.onclick = () => { currentPage = i; renderBooks(); };
        pagination.appendChild(btn);
      }
    }

    function toggleAnnotation(id) {
      const el = document.getElementById(id);
      if (el) {
        const isHidden = window.getComputedStyle(el).display === 'none';
        el.style.display = isHidden ? 'block' : 'none';
      }
    }

    function updateURLParams() {
      const params = new URLSearchParams();
      params.set('search', document.getElementById('searchInput').value);
      params.set('year', document.getElementById('yearSelect').value);
      params.set('genre', document.getElementById('genreSelect').value);
      params.set('language', document.getElementById('languageSelect').value);
      params.set('letter', activeLetter);
      history.replaceState(null, '', '?' + params.toString());
    }

    function readURLParams() {
      const params = new URLSearchParams(window.location.search);
      document.getElementById('searchInput').value = params.get('search') || '';
      document.getElementById('yearSelect').value = params.get('year') || '';
      document.getElementById('genreSelect').value = params.get('genre') || '';
      document.getElementById('languageSelect').value = params.get('language') || '';
      activeLetter = params.get('letter') || '';
      if (activeLetter) {
        const letterSpan = [...document.querySelectorAll('.alphabet span')].find(s => s.textContent === activeLetter);
        if (letterSpan) filterByLetter(activeLetter, letterSpan);
      }
    }

    document.getElementById('searchInput').addEventListener('input', applyFilters);
    loadBooks();
  </script>
</body>
</html>
